@using Corno.Globals.Constants
@using Corno.Services.Bootstrapper
@using Corno.Services.Corno.Masters.Interfaces
@using Kendo.Mvc.UI
@model Corno.Data.Corno.Question_Bank.Models.Paper

@{
    ViewBag.Controller = "MathTypePaper";
    ViewBag.Action = ModelConstants.Edit;

    var facultyService = Bootstrapper.Get<IFacultyService>();
    var courseService = Bootstrapper.Get<ICourseService>();
    var coursePartService = Bootstrapper.Get<ICoursePartService>();
    var branchService = Bootstrapper.Get<IBranchService>();
    var subjectService = Bootstrapper.Get<ISubjectService>();
    var miscMasterService = Bootstrapper.Get<IMiscMasterService>();

    var theoryCategories = new List<int> { 2, 48 };
    var subject = subjectService.GetById(Model.SubjectId);
    var subjectMarks = subject.SubjectCategoryDetails
        .Where(d => theoryCategories.Contains(d.CategoryId))
        .Sum(d => d.MaxMarks);
}

@if (TempData["Success"] != null)
{
    <script type="text/javascript">
        bootbox.alert("@TempData["Success"]")
    </script>
}

<div class="form-horizontal box-content">
    @using (Html.BeginForm("Edit", "MathTypePaper", FormMethod.Post, new { id = "form", enctype = "multipart/form-data" }))
    {
        @Html.ValidationSummary(false)
        @Html.AntiForgeryToken()

        @Html.HiddenFor(m => m.Id)
        @Html.HiddenFor(m => m.SerialNo)
        <div class="k-card k-card-vertical">
            <div class=".card-header-without-margin-padding k-card-tertiary">
                <div class="k-card-actions k-card-actions-horizontal k-card-actions-start col-sm-8">
                    <h4>Edit Set : @Model.SerialNo</h4>
                </div>
                <div class="k-card-actions k-card-actions-horizontal k-card-actions-end col-sm-4">
                    @(Html.Kendo().Button()
                            .Name("back_to_list")
                            .Icon("arrow-left")
                            .SpriteCssClass("k-icon-64")
                            .FillMode(ButtonFillMode.Outline)
                            .ThemeColor(ThemeColor.Info)
                            .Content("Back To list")
                            .Events(e => e.Click("onBackToList"))
                            .HtmlAttributes(new { @class = "w-100" }))
                </div>
            </div>
            <div class="k-card-body">
                <table class="table">
                    <tr>
                        <td>Faculty :</td>
                        <td colspan="7">
                            @Html.HiddenFor(p => p.FacultyId)
                            <span id="facultyName">@{@facultyService.GetViewModel(Model.FacultyId).NameWithId}</span>
                        </td>
                    </tr>
                    <tr>
                        <td>Course :</td>
                        <td colspan="7">
                            @Html.HiddenFor(p => p.CourseId)
                            <span id="courseName">@{@courseService.GetViewModel(Model.CourseId).NameWithId}</span>
                        </td>
                    </tr>
                    <tr>
                        <td>Course Part :</td>
                        <td colspan="7">
                            @Html.HiddenFor(p => p.CoursePartId)
                            <span id="coursePartName">@{@coursePartService.GetViewModel(Model.CoursePartId).NameWithId}</span>
                        </td>
                    </tr>
                    <tr>
                        <td>Branch :</td>
                        <td colspan="7">
                            @Html.HiddenFor(p => p.BranchId)
                            @{
                                if ((Model.BranchId ?? 0) > 0)
                                {
                                    @branchService.GetViewModel(Model.BranchId).NameWithId
                                }
                            }
                        </td>
                    </tr>
                    <tr>
                        <td>Subject :</td>
                        <td colspan="7">
                            @Html.HiddenFor(p => p.SubjectId)
                            <span id="subjectName">(@subject.Id) - @subject.Name</span>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="1">
                            @Html.HiddenFor(p => p.PaperCategoryId)
                            Paper:
                            @{
                                if ((Model.PaperCategoryId ?? 0) > 0)
                                {
                                    <span id="paperCategoryName"><strong>@miscMasterService.GetViewModel(Model.PaperCategoryId).NameWithId</strong></span>
                                }
                            }
                        </td>
                        <td colspan="6">
                            @Html.HiddenFor(p => p.NoOfSections)
                            @Html.HiddenFor(p => p.NoOfChapters)
                            @Html.HiddenFor(p => p.NoOfQuestions)
                            @Html.HiddenFor(p => p.MaxMarks)

                            Sections : <strong>@Model.NoOfSections</strong> | Chapters : <strong>@Model.NoOfChapters</strong> | Questions : <strong>@Model.NoOfQuestions</strong> | Paper Marks: <strong>@Model.MaxMarks</strong> | Subject Marks: <strong>@subjectMarks</strong>
                        </td>
                    </tr>
                </table>

                @Html.Partial("~/Areas/Question Bank/Views/MathTypePaper/_QuestionInfo.cshtml", Model,
                    new ViewDataDictionary { { ModelConstants.FormEnabled, false } })

                @Html.Partial("~/Areas/Question Bank/Views/MathTypePaper/_Detail.cshtml", Model)

                @*Upload model answer*@
                <div style="display: none !important;">
                    @(Html.Kendo().Upload()
                    .Name("pdfModelAnswer")
                    .Multiple(false)
                    .Events(e => e
                        .Upload("onUploadModelAnswer")
                        .Success("onUploadSuccess")
                        .Error("onUploadError")
                    )
                    .Async(a => a
                        .Save("UploadModelAnswer", "MathTypePaper"/*, new {paper = Model}*/)
                        .AutoUpload(true))
                    .HtmlAttributes(new { accept = ".pdf", style= "display: none !important;" })
                    .Validation(v => v.AllowedExtensions(new[] { ".pdf" })))
                </div>
            </div>
            <div class="k-card-footer">
                <div class="row">
                    <div class="k-card-actions k-card-actions-horizontal k-card-actions-end">
                        @(Html.Kendo().Button()
                                 .Name("btnAnalysis")
                                 .Icon("display-inline-block")
                                 .SpriteCssClass("k-icon-64")
                                 .FillMode(ButtonFillMode.Outline)
                                 .ThemeColor(ThemeColor.Tertiary)
                                 .Content("Analysis Report")
                                 .HtmlAttributes(new
                                 {
                                     type = "submit",
                                     name = "action:Analysis",
                                     @class = "w-100"
                                 }))
                        @(Html.Kendo().Button()
                            .Name("btnUploadModelAnswer")
                            .Icon("upload")
                            .SpriteCssClass("k-icon-64")
                            .FillMode(ButtonFillMode.Outline)
                            .ThemeColor(ThemeColor.Tertiary)
                            .Content("Upload Model Answer")
                            .HtmlAttributes(new
                            {
                                //type = "submit",
                                //name = "action:UploadModelAnswer",
                                @class = "w-100",
                                onclick = "$('#pdfModelAnswer').click();"
                            }))
                        @if (User.IsInRole(RoleConstants.Admin) || User.IsInRole(RoleConstants.QuestionBank) ||
                             User.IsInRole(RoleConstants.PaperSetter))
                        {
                            @(Html.Kendo().Button()
                                .Name("draw_paper")
                                .Icon("file-txt")
                                .SpriteCssClass("k-icon-64")
                                .FillMode(ButtonFillMode.Outline)
                                .ThemeColor(ThemeColor.Tertiary)
                                .Content("Draw")
                                .HtmlAttributes(new
                                {
                                    type = "submit",
                                    name = "action:Draw",
                                    @class = "w-100"
                                }))
                        }

                        @(Html.Kendo().Button()
                            .Name("preview_paper")
                            .Icon("display-inline-block")
                            .SpriteCssClass("k-icon-64")
                            .FillMode(ButtonFillMode.Outline)
                            .ThemeColor(ThemeColor.Tertiary)
                            .Content("Preview")
                            .HtmlAttributes(new
                            {
                                type = "submit",
                                name = "action:Preview",
                                @class = "w-100"
                            }))
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<div id="output"></div>

<script>
    $(document).ready(function () {
        $("#form").kendoValidator().data("kendoValidator");
    });

    @*function onUploadModelAnswer(e) {
        console.log("in onUploadModelAnswer, facultyName : " + $("#facultyName").text());
        // Add additional form data
        e.data = {
            facultyName: '@Model.FacultyId',
            courseName: '@Model.CourseId',
            coursePartName: '@Model.CoursePartId',
            subjectName: '@Model.SubjectId',
            paperCategoryName: $("#paperCategoryName").text(),
        };
    }*@

    function onUploadModelAnswer(e) {
        var formDataArray = $("#form").serializeArray();
        var formDataObject = {};

        $.each(formDataArray, function (i, field) {
            formDataObject[field.name] = field.value;
        });

        console.log("Form Data : " + JSON.stringify(formDataObject));

        // Attach model data to the upload event
        e.data = formDataObject;
    }

    function onUploadSuccess(e) {
        if (e.response && e.response.success) {
            bootbox.alert("✅ Upload successful: " + e.response.message);
        } else {
            bootbox.alert("⚠️ Upload failed: " + (e.response?.message || "Unknown error."));
        }
    }

    function onUploadError(e) {
        bootbox.alert("❌ Upload error: A network or server issue occurred.");
    }

    function onBackToList() {
        window.location.href = '/Question Bank/MathTypePaper/Index';
    }
</script>

