@using Corno.Data.Corno.Question_Bank.Dtos
@using Corno.Globals.Constants
@using Corno.OnlineExam.Helpers
@using Kendo.Mvc.UI
@model Corno.Data.Corno.Question_Bank.Models.Question

@{
    const string controller = "Question";
    string action = ViewBag.Action.ToString();
}

@if (TempData["Success"] != null)
{
    <script type="text/javascript">
        bootbox.alert("@TempData["Success"]")
    </script>
    TempData["Success"] = null;
}

<style>
    table {
        width: 100%;
        border-collapse: collapse;
    }

    td.auto-width {
        width: auto;
        white-space: nowrap;
    }

    td.full-width {
        width: 30%;
    }
    .required-star { color: red; margin-left: 4px; }
</style>

<div class="form-horizontal box-content">
    @using (Html.BeginForm(action, controller, FormMethod.Post, new { id = "form", enctype = "multipart/form-data" }))
    {
        @Html.ValidationSummary(false)
        @Html.AntiForgeryToken()

        @Html.HiddenFor(m => m.Id)
        @Html.HiddenFor(m => m.FacultyId)
        @Html.HiddenFor(m => m.CourseId)
        @Html.HiddenFor(m => m.CoursePartId)
        @Html.HiddenFor(m => m.SubjectId)
        @Html.HiddenFor(m => m.SubjectName)
        @Html.HiddenFor(m => m.PaperCategoryId)

        <div class="k-card k-card-vertical">
            <div class="k-card-title k-card-tertiary row">
                <div class="col-sm-6">
                    <h4>Add new question</h4>
                </div>
                <div class="k-card-actions k-card-actions-horizontal k-card-actions-end col-sm-6">
                    @(Html.Kendo().Button()
                                 .Name("back_to_list")
                                 .Icon("arrow-left")
                                 .SpriteCssClass("k-icon-64")
                                 .FillMode(ButtonFillMode.Outline)
                                 .ThemeColor(ThemeColor.Info)
                                 .Content("Back To list")
                                 .Events(e => e.Click("onBackToList"))
                                 .HtmlAttributes(new { @class = "w-100" }))
                </div>
            </div>
            <div class="k-card-body">
                <table class="table">
                    <tr>
                        <td class="auto-width">Subject :</td>
                        <td colspan="4">@Model.SubjectName</td>
                    </tr>
                    <tr>
                        <td class="auto-width">Chapter <span class="required-star">*</span> :</td>
                        <td class="full-width">
                            @(Html.Kendo().MultiColumnComboBoxFor(m => m.ChapterId)
                                .DataTextField(ModelConstants.NameWithId)
                                .DataValueField(ModelConstants.Id)
                                .HtmlAttributes(new { @class="w-100"})
                                .Filter(FilterType.Contains)
                                .Placeholder("Select ...")
                                .Columns(columns =>
                                {
                                    columns.Add().Field(ModelConstants.Id).Width("100px");
                                    columns.Add().Field(ModelConstants.SerialNo).Width("100px");
                                    columns.Add().Field(ModelConstants.Name).Width("600px");
                                })
                                .DataSource(dataSource => dataSource
                                    .Read(read => read.Action("GetChapters", "Question", new {Model.SubjectId, Model.PaperCategoryId}))
                                ))
                        </td>
                        <td></td>
                        <td class="auto-width">Question Type <span class="required-star">*</span> :</td>
                        <td class="full-width">
                            @(Html.Kendo().MultiColumnComboBoxFor(m => m.QuestionTypeId)
                                .DataTextField(ModelConstants.Name)
                                .DataValueField(ModelConstants.Id)
                                .HtmlAttributes(new { @class = "w-100" })
                                .Filter("contains")
                                .Placeholder("Select ...")
                                .Columns(columns =>
                                {
                                    columns.Add().Field(ModelConstants.Id).Title(ModelConstants.Id).Width("100px");
                                    columns.Add().Field(ModelConstants.Name).Title(ModelConstants.Name).Width("600px");
                                })
                                .DataSource(dataSource => dataSource
                                    .Read(read => read.Action("GetQuestionTypes", "Question", new { area = "Question Bank", Model.SubjectId, Model.PaperCategoryId })
                                        .Data("filterQuestionTypes"))
                                    .ServerFiltering(true)
                                )
                                .CascadeFrom(ModelConstants.ChapterId))
                            <script>
                                function filterQuestionTypes() {
                                    var comboBox = $("#ChapterId").data("kendoMultiColumnComboBox");
                                    var dataItem = comboBox.dataItem();

                                    return {
                                        chapterSerialNo: dataItem ? dataItem.SerialNo : null
                                    };
                                }
                            </script>

                        </td>
                    </tr>
                    <tr>
                        <td class="auto-width">Difficulty Level <span class="required-star">*</span> :</td>
                        <td class="full-width">
                            @(Html.Kendo().MultiColumnComboBoxFor(m => m.DifficultyLevel)
                                .DataTextField(ModelConstants.Name)
                                .DataValueField(ModelConstants.Id)
                                .HtmlAttributes(new { @class = "w-100" })
                                .Value(Model.DifficultyLevel.ToString())
                                .Filter("contains")
                                .Placeholder("Select ...")
                                .Columns(columns =>
                                {
                                    columns.Add().Field(ModelConstants.Id).Width("100px");
                                    columns.Add().Field(ModelConstants.Name).Width("600px");
                                })
                                .DataSource(dataSource => dataSource
                                    .Read(read => read.Action("GetDifficultyLevels", "Corno"))
                                ))
                        </td>
                        <td></td>
                        <td class="auto-width">Learning Priority :</td>
                        <td class="full-width">
                            @(Html.Kendo().MultiColumnComboBoxFor(m => m.LearningPriorityId)
                                .DataTextField(ModelConstants.Name)
                                .DataValueField(ModelConstants.Id)
                                .HtmlAttributes(new { @class = "w-100" })
                                .Filter("contains")
                                .Placeholder("Select ...")
                                .Columns(columns =>
                                {
                                    columns.Add().Field(ModelConstants.Id).Width("100px");
                                    columns.Add().Field(ModelConstants.Name).Width("600px");
                                })
                                .DataSource(dataSource => dataSource
                                    .Read(read => read.Action("GetMiscMasters", "Corno", new { miscType = "LearningPriority" }))
                                ))
                        </td>
                    </tr>
                    <tr>
                        <td class="auto-width">CO No. :</td>
                        <td class="full-width">
                            @(Html.Kendo().NumericTextBoxFor(m => m.CoNo)
                                .Decimals(0).Min(0).Format("n0")
                                .Value(Model.CoNo ?? 0)
                                .HtmlAttributes(new { @class = "text-right w-100" }))
                        </td>
                        <td></td>
                        <td class="auto-width">Marks <span class="required-star">*</span> :</td>
                        <td class="full-width">
                            @(Html.Kendo().NumericTextBoxFor(m => m.Marks)
                                .Decimals(0).Min(0).Format("n0")
                                .Value(Model.Marks ?? 0)
                                // Make the control readonly instead of disabled so the value is visible and posted
                                .HtmlAttributes(new { @class = "text-right w-100", @readonly = "readonly" }))
                        </td>
                    </tr>
                    <tr>
                        <td colspan="4">
                            <div style="overflow-x: auto;">
                                @(Html.Kendo().Grid<QuestionAppointmentTypeDetailDto>()
                                    .Name("gridQuestionTypes")
                                    //.ApplyCommonSettings(height:200) // 👈 Apply shared settings
                                    .HtmlAttributes(new { style = "width: auto; background-color:#fffbe6;" })
                                    .Events(events => events.ApplyCommonEvents())
                                    .Columns(columns =>
                                    {
                                        //columns.Bound(m => m.Id);
                                        columns.Bound(m => m.PaperCategoryName)
                                            .HeaderHtmlAttributes(new { style = "text-align:center; font-weight:bold" })
                                            .Title("Paper Category");
                                        columns.Bound(m => m.QuestionTypeName)
                                            .HeaderHtmlAttributes(new { style = "text-align:center; font-weight:bold" })
                                            .Title("Question Type");
                                        columns.Bound(m => m.QuestionCount)
                                            .HeaderHtmlAttributes(new { style = "text-align:center; font-weight:bold" })
                                            .Title("Required Question Count")
                                            .Align(TextAlign.Center);
                                        columns.Bound(m => m.CompletedCount)
                                            .HeaderHtmlAttributes(new { style = "text-align:center; font-weight:bold" })
                                            .Title("Completed Count")
                                            .Align(TextAlign.Center);
                                    })
                                    .DataSource(dataSource => dataSource
                                        //.ApplyCommonDataSourceSettings("GetQuestionTypeDtos", "Question", "Question Bank")
                                        .Ajax()
                                        .PageSize(10)
                                        .Read(read => read.Action("GetQuestionTypeDtos", "Question", new
                                        {
                                            area = "Question Bank", subjectId = @Model.SubjectId, paperCategoryId = Model.PaperCategoryId
                                        }).Data("sendData"))
                                        .Model(model => model.Id(ModelConstants.Id))
                                        .Events(events => events.Error("onGridError"))
                                        .Sort(s => s.Add(ModelConstants.Id).Descending())
                                    ))
                            </div>
                        </td>
                        <td class="k-text-align-right">
                            <div class="k-actions k-actions-horizontal k-actions-end">
                                @(Html.Kendo().Button()
                                    .Name("btnViewTemplate")
                                    .Icon("file")
                                    .SpriteCssClass("k-icon-64")
                                    .FillMode(ButtonFillMode.Outline)
                                    .ThemeColor(ThemeColor.Tertiary)
                                    .Content("ViewTemplate")
                                    .HtmlAttributes(new
                                    {
                                        type = "submit",
                                        name = "action:ViewTemplate"
                                    }))
                                @(Html.Kendo().Button()
                                    .Name("save")
                                    .Icon("save")
                                    .SpriteCssClass("k-icon-64")
                                    .FillMode(ButtonFillMode.Outline)
                                    .ThemeColor(ThemeColor.Success)
                                    .Content("Save")
                                    .HtmlAttributes(new
                                    {
                                        type = "submit",
                                        name = string.Format("action:{0}", action),
                                    }))
                            </div>
                        </td>
                    </tr>
                </table>
                <div class="form-group row">
                    <div class="col-sm-6">
                        <label for="Description" class="form-label"><strong>Enter Question</strong> <span class="required-star">*</span> :</label>
                        @Html.TextAreaFor(m => m.Description, new { id = "Description", @class = "form-control" })
                    </div>
                    <div class="col-sm-6">
                        <label for="ModelAnswer" class="form-label"><strong>Enter Model Answer <span class="required-star">*</span>:</strong></label>
                        @Html.TextAreaFor(m => m.ModelAnswer, new { id = "ModelAnswer", @class = "form-control" })
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    @(Html.Kendo().Grid<QuestionListDto>()
                             .Name("gridQuestion")
                             .ToolBar(toolbar => toolbar.Search())
                             .Events(events => events.ApplyCommonEvents())
                             .Search(s =>
                             {
                                 s.Field(f => f.Description);
                                 s.Field(f => f.ModelAnswer);
                                 s.Field(f => f.QuestionTypeName);
                                 s.Field(f => f.ChapterName);
                                 s.Field(f => f.PaperCategoryName);
                             })
                             .Columns(columns =>
                             {
                                 columns.Bound(m => m.Id);
                                 columns.Bound(m => m.Date)
                                     .Format("{0:dd/MM/yyyy}");
                                 columns.Bound(m => m.Description)
                                     .Title("Question")
                                     .Encoded(false).Align(TextAlign.Left);
                                 columns.Bound(m => m.ModelAnswer)
                                     .Title("Model Answer")
                                     .Encoded(false).Align(TextAlign.Left);
                                 columns.Bound(m => m.QuestionTypeName)
                                     .Align(TextAlign.Left)
                                     .Title("Question Type");
                                 columns.Bound(m => m.TaxonomySerialNo)
                                     .Title("Taxonomy")
                                     .Align(TextAlign.Center);
                                 columns.Bound(m => m.Marks);
                                 columns.Bound(m => m.ChapterName)
                                     .Align(TextAlign.Left)
                                     .Title("Chapter");
                                 columns.Bound(m => m.DifficultyLevelName)
                                     .Title("Difficulty Level");
                                 columns.Bound(m => m.PaperCategoryName)
                                     .Align(TextAlign.Left)
                                     .Title("Paper Category");
                                 columns.Bound(m => m.CoNo);
                                 columns.AddStatusColumn();
                                 columns.AddCommandColumns(new List<GridCommandConfig>
                                 {
                                     new GridCommandConfig { Name = "Edit", Text = "", IconClass = "fa fa-edit", ClickHandler = "onEditClick" },
                                     /*new() { Name = "Delete", Text = "", IconClass = "fa fa-trash", ClickHandler = "onDeleteClick" },
                 new() { Name = "View", Text = "", IconClass = "k-icon k-i-preview k-i-eye", ClickHandler = "onViewClick" },
                 new() { Name = "Print", Text = "", IconClass = "fa fa-print", ClickHandler = "onPrintClick" }*/
                                 });
                             })
                             .DataSource(dataSource => dataSource
                                 //.ApplyCommonDataSourceSettings("GetQuestionDtos", "Question", "Question Bank")
                                 .Ajax()
                                 .PageSize(10)
                                 .Read(read => read.Action("GetQuestionDtos", "Question", new { area = "Question Bank", subjectId = @Model.SubjectId }).Data("sendData"))
                                 .Model(model => model.Id(ModelConstants.Id))
                                 .Events(events => events.Error("onGridError"))
                                 .Sort(s => s.Add(ModelConstants.Id).Descending())
                             ))
                </div>
            </div>
        </div>
    }

</div>
<script>
    $(document).ready(function () {
        $("#form").kendoValidator().data("kendoValidator");
    });

    function onBackToList() {
        window.location.href = '/Question Bank/Question/Index';
    }

    function onChange() {

    }

    function sendData() {
        @*console.log("Subject Id : " + '@Model.SubjectId');
        subjectId = '@Model.SubjectId';*@
    }

    function onEditClick(e) {
        e.preventDefault();
        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        window.location.href = '@Url.Action("Edit", "Question")' + '/' + dataItem.Id;
    }

    function onBoundChange() {
        console.log("event: bound change, Detail count : ");
    }
</script>

<style>
    .ck-editor__editable {
        font-family: 'Times New Roman', Times, serif !important;
        font-size: 12pt !important;
    }
</style>

<!-- Load CKEditor -->
<link rel="stylesheet" href="~/Scripts/ckeditor/styles.css" />
<script src="~/Scripts/ckeditor/ckeditor.js"></script>

<script>
    let descriptionEditor;
    let modelAnswerEditor;

    document.addEventListener("DOMContentLoaded", function () {
        // Initialize Description Editor
        ClassicEditor
            .create(document.querySelector('#Description'), {
                extraPlugins: [MyCustomUploadAdapterPlugin],
                toolbar: {
                    shouldNotGroupWhenFull: true
                },
                simpleUpload: {
                    uploadUrl: '/Question%20Bank/Question/UploadImage',
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    }
                }
            })
            .then(editor => {
                descriptionEditor = editor;
                console.log('Description Editor initialized', editor);
            })
            .catch(error => {
                console.error('Description Editor initialization error:', error);
            });

        // Initialize Model Answer Editor
        ClassicEditor
            .create(document.querySelector('#ModelAnswer'), {
                extraPlugins: [MyCustomUploadAdapterPlugin],
                toolbar: {
                    shouldNotGroupWhenFull: true
                },
                simpleUpload: {
                    uploadUrl: '/Question%20Bank/Question/UploadImage',
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    }
                }
            })
            .then(editor => {
                modelAnswerEditor = editor;
                console.log('Model Answer Editor initialized', editor);
            })
            .catch(error => {
                console.error('Model Answer Editor initialization error:', error);
            });
    });

    function MyCustomUploadAdapterPlugin(editor) {
        editor.plugins.get('FileRepository').createUploadAdapter = (loader) => {
            return new MyUploadAdapter(loader);
        };
    }

    @*document.addEventListener("DOMContentLoaded", function () {
        ClassicEditor
            .create(document.querySelector('#Description'))
            .then(editor => {
                editor.plugins.get('FileRepository').createUploadAdapter = (loader) => {
                        return new MyUploadAdapter(loader);
                    };
                //console.log('Editor initialized', editor);
            })
            .catch(error => {
                console.error('Editor initialization error:', error);
            });
    });*@

    document.querySelector("form").addEventListener("submit", function () {
        // Assign CKEditor data to textarea before submit
        if (descriptionEditor) {
            console.log("Description Data : " + descriptionEditor.getData())
            document.getElementById("Description").value = descriptionEditor.getData();
        }
        if (modelAnswerEditor) {
            console.log("Model Answer Data : " + modelAnswerEditor.getData())
            document.getElementById("ModelAnswer").value = modelAnswerEditor.getData();
        }
    });

</script>


@*<script src="~/Scripts/ckeditor/ckeditor.js"></script>
    <script>
        // Add External Plugins for MathType, ChemType, and Font
        CKEDITOR.plugins.addExternal('ckeditor_wiris', 'https://www.wiris.net/demo/plugins/ckeditor/', 'plugin.js');
        CKEDITOR.plugins.addExternal('kekule', 'plugins/Kekule/src/_extras/CKEditorPlugins/kekule/', 'plugin.js');
        CKEDITOR.plugins.addExternal('font', 'plugins/font/', 'plugin.js');

        // Initialize CKEditor
        CKEDITOR.replace('Description', {
            width: '100%',
            height: '200px',

            $1$filebrowserUploadUrl: '/Question/Upload',       // File upload URL
            filebrowserUploadMethod: 'form',                // Upload method#1#

            extraPlugins: 'ckeditor_wiris,kekule,font',     // Load additional plugins
            allowedContent: true,
            font_defaultLabel: 'Times New Roman',
            fontSize_defaultLabel: '12px',
            contentsCss: ['body { font-family: Times New Roman, serif; font-size: 12px; }'],
            wirisMathML: {
                renderMode: 'mathml'
            }
            $1$wirisMathML: {
                fontFamily: 'Times New Roman',
                fontSize: '12px'
            }#1#
            $1$font_defaultLabel: 'Times New Roman',
            fontSize_defaultLabel: '12px',
            contentsCss: ['https://fonts.googleapis.com/css?family=Times+New+Roman']#1#
        });

        // Debugging: Ensure MathType-specific settings are applied
        CKEDITOR.on('instanceReady', function (event) {
            var editor = event.editor;
            if (editor.plugins.ckeditor_wiris) {
                $1$editor.plugins.ckeditor_wiris.setParameters({
                    fontName: 'Times New Roman',
                    fontSize: '12px'
                });#1#
            }
        });

        document.querySelector("form").addEventListener("submit", function () {
            // Assign CKEditor data to textarea before submit
            if (editor) {
                console.log("Data : " + editor.getData())
                document.getElementById("Description").value = editor.getData();
            }
        });
    </script>*@