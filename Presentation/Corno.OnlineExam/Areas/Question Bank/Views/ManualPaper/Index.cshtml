@using Corno.Data.ViewModels
@using Corno.Globals.Constants
@using Kendo.Mvc.UI
@model Corno.Data.Corno.Question_Bank.Models.Paper

@{
    ViewBag.Title = "Manual Paper";
}

<div class="row">
    <div class="box-content">
        <div id="breadcrumb" class="col-md-12">
            <ol class="breadcrumb">
                <li><a href="#">OnlineExam</a></li>
                <li><a href="#">Question Bank</a></li>
                <li><a href="#">Manual Paper</a></li>
            </ol>
        </div>
    </div>
</div>

<div class="k-card k-card-vertical">
    <div class="k-card-header k-card-tertiary">
        <div class="row">
            <div class="col-sm-8">
                <h3>Manual Papers</h3>
            </div>
            <div class="k-card-actions k-card-actions-horizontal k-card-actions-end col-sm-4">
                @(Html.Kendo().Button()
                    .Name("New")
                    .Icon("plus")
                    .SpriteCssClass("k-icon-64")
                    .FillMode(ButtonFillMode.Outline)
                    .ThemeColor(ThemeColor.Info)
                    .Content("Add New")
                    .Events(e => e.Click("onCreate"))
                    .HtmlAttributes(new{@class = "w-100"}))
            </div>
        </div>
    </div>
    <div class="k-card-body">
        <div style="overflow-x: auto" class="">
            @(Html.Kendo().Grid<PaperIndexDto>()
                .Name("grid")
                .ToolBar(t => t.Search())
                .Pageable()
                .Sortable()
                .Filterable(f => f.Mode(GridFilterMode.Row))
                .Resizable(resize => resize.Columns(true)) // Allow column resizing
                .PersistSelection()
                .Width(2000)
                //.HtmlAttributes(new { @class = "w-100" })
                .Columns(columns =>
                {
                    columns.Bound(m => m.Id)
                        .HtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
                        .HeaderHtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
                        .Title("Code");
                    columns.Bound(m => m.SetNo)
                        .HtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
                        .HeaderHtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
                        .Title("Set No");
                    columns.Command(command =>
                        {
                            command.Custom("Edit").Text("Edit").IconClass("k-icon k-i-pencil")
                                .HtmlAttributes(new { @class = "k-grid-edit" })
                                .Visible("function(dataItem) { return dataItem.Status === 'Active'; }"); // Show only if Status is "Active";
                            command.Custom("Preview").Text("Preview").IconClass("k-icon k-i-eye")
                                .HtmlAttributes(new { @class = "k-grid-preview w-100 k-button k-button-sm k-rounded-sm k-button-outline k-button-outline-info" })
                                .Visible("function(dataItem) { return dataItem.Status === 'Drawn'; }"); 
                        })
                        .HeaderHtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
                        .HtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
                        .Title("Actions"); // Add a class to identify the command column;
                    columns.Bound(m => m.PaperCategoryName)
                        .HeaderHtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
                        .Title("Paper");
                    columns.Bound(m => m.SubjectName)
                        .HeaderHtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
                        .HtmlAttributes(new { @class = "k-text-left !k-justify-content-left" })
                        .ClientGroupHeaderTemplate("<span style='font-weight:bold;'>Subject :</span> <span style='font-weight:normal;'>#= value #</span>")
                        .Title("Subject");
                    columns.Bound(m => m.CourseName)
                        .HeaderHtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
                        .HtmlAttributes(new { @class = "k-text-left !k-justify-content-left" })
                        .Title("Course");
                    columns.Bound(m => m.FacultyName)
                        .HeaderHtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
                        .HtmlAttributes(new { @class = "k-text-left !k-justify-content-left" })
                        .Title("Faculty");
                    columns.Bound(m => m.Status)
                        .ClientTemplate(
                            "<span class='badge' style='background-color: " +
                            "# if (Status == \"Drawn\") { #" +
                            "green" +
                            "# } else if (Status == \"Active\") { #" +
                            "blue" +
                            "# } else if (Status == \"Used\") { #" +
                            "red" +
                            "# } else { #" +
                            "transparent" +
                            "# } #" +
                            "; color: " +
                            "# if (Status == \"Drawn\" || Status == \"Active\" || Status == \"Used\") { #" +
                            "white" +
                            "# } else { #" +
                            "black" +
                            "# } #" +
                            "; text-align: center; display: inline-block;'>" +
                            "#= Status #</span>"
                        )
                        .HtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
                        .HeaderHtmlAttributes(new { @class = "k-text-center !k-justify-content-center" });
                })
                .Events(events => events.DataBound("onDataBound"))
                .DataSource(dataSource => dataSource
                    .Ajax()
                    .Read(read => read.Action("GetIndexPapers", "ManualPaper"))
                    .Sort(sort => sort.Add(ModelConstants.Id).Ascending()) // Initial sort by Id in ascending order
                    /*.Group(group =>
                    {
                        group.Add(g => g.FacultyName);
                        group.Add(g => g.CourseName);
                        //group.Add(g => g.SubjectName);
                    })*/
                    .Model(model => model.Id(ModelConstants.Id))
                ))
        </div>
    </div>
</div>


<script>
    function onCreate() {
        window.location.href = '/ManualPaper/Create';
    }

    function onDataBound(e) {
        var grid = $("#grid").data("kendoGrid");
        // Auto-fit each column
        grid.columns.forEach(function (column, index) {
            grid.autoFitColumn(index);
        });

        $(".k-grid-edit").on("click", function () {
            var grid = $("#grid").data("kendoGrid");
            var row = $(this).closest("tr");
            var dataItem = grid.dataItem(row);

            if (dataItem) {
                var id = dataItem.Id; // Assuming Id is the unique identifier of the item
                window.location.href = '/ManualPaper/Edit/' + id; // Replace with your edit page URL
            }
        });
        $(".k-grid-preview").on("click", function () {
            var grid = $("#grid").data("kendoGrid");
            var row = $(this).closest("tr");
            var dataItem = grid.dataItem(row);

            if (dataItem) {
                var id = dataItem.Id; // Assuming Id is the unique identifier of the item
                window.location.href = '/ManualPaper/Preview/' + id; // Replace with your edit page URL
                //sendId(id);
            }
        });
    }

    function sendId(id) {
        fetch('/Question Bank/ManualPaper/Preview', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ Id: id })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json(); // Adjust this based on your server response
            })
            .then(data => {
                console.log('Success:', data);
                // Do something with the response if needed
            })
            .catch((error) => {
                console.error('Error:', error);
            });
    }

</script>